{% extends 'base.html' %}

{% block script %}
	<script type="text/javascript" charset="utf-8">
        $(document).ready(function(){
            namespace = '{{prefix}}';
            var msgCount = 1;
			var client_id = Date.now()
            var spk='USER';
            var port='{{port}}';
            if(port.length>0){
                var ws = new WebSocket('{{protocol}}://{{server}}:{{port}}' + namespace+`${client_id}`);
            }else{
                var ws = new WebSocket('{{protocol}}://{{server}}' + namespace+`${client_id}`);
            }
			$('#send').click(function(e) {
                var msg = String($('#msg').val());
                if(msg.trim().length>0){
                    ws.send(JSON.stringify({'cmd':'input completed','msg':msg}));
                    $('#log').append('<br>' +msgCount + '. '+ spk+':'+msg);
                    $('#msg').val('');
                    $('#msg').focus();
                    $('#send').prop('disabled',true)
                    msgCount += 1;
      			    return false;
                }
    		});
            $('#start').click(function(e) {
                ws.send(JSON.stringify({'cmd':'start','conversation':"{{chat_name}}"}));
				console.log('start');
                $('#start').prop('disabled',true)
                $('#msg').focus();
      			return false;
    		});
            ws.onmessage = function(event) {
				data=JSON.parse(event.data);
                // SAY
				if(data.cmd=="say"){
                	$('#last_say').html(data.msg);
                    //let utter = new SpeechSynthesisUtterance();
                    //utter.lang = 'es-MX';
                    //utter.text = data.msg;
                    //utter.volume = 0.5;
                    // speak
                    //window.speechSynthesis.speak(utter);
                    $('#log').append('<br>' +msgCount + '. '+ data.spk+':'+data.msg);
					console.log('say');
                	msgCount += 1;
				};
			    if(data.cmd=="activate input"){
                    $('#send').prop('disabled',false);
                    spk=data.spk;
				    console.log('activate input');
                };
            };

            /*socket.on('input log', function(data) {
                $('#log').append('<br>' + $('<div/>').text(msgCount + '. '+ data.spk + ':' + data.msg).html());
				console.log('input log');
                msgCount += 1;
            });

            socket.on('finished log', function(data) {
                $('#start').prop('disabled',false)
                msgCount = 0;
                $('#log').append('<br><hr>');
				console.log('finished');
            });

 			socket.on('audio log', function(data) {
				console.log('audio');
				if(data.main == 2){
                	$('#audio').text("Esperando que hables");
				}
				if(data.main == 3){
                	$('#audio').text("Escuchandote");
				}if(data.main == 4){
                	$('#audio').text("Hablando");
				}
            }); */
        });
    </script>
{% endblock %}

{% block content %}

	<div class="container">
	<center>
    <button id="start" class="primary">Start</button>
	</center>
	</div>

    <div class="container">

    <h3>Audio status</h3>
    <p><div id='audio'></div></p>

    <form action="">
        <div class="row">
              <div class="col-sm-12">
        <label id="last_say">Mensaje</label>
            </div>
            </div>
        <div class="row">
              <div class="col-sm-11">
        <input type="text" id="msg" autocomplete="off"  style="width:90%;"/>
                </div>
              <div class="col-sm-1">
        <button id="send" class="primary" disabled>Enviar</button>
                </div>
                </div>
    </form>
    <div class="row">
        <div class="card large">
        <h3>Messages received</h3>
        <div class="section dark">
        <div id='log'>
        </div>
        </div>
        </div>
    </div>
    </div>
{% endblock %}
